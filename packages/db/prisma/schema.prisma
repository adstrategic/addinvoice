// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
    provider   = "prisma-client"
    output     = "../src/generated/prisma"
    engineType = "client"
}

datasource db {
    provider = "postgresql"
}

model Workspace {
    id      Int    @id @default(autoincrement())
    clerkId String @unique // Clerk's user ID - no need for separate User table

    // Business/Company Information (for invoices)
    name           String // Company/Workspace name
    companyName    String? // Full company name for invoices
    companyAddress String? // Company address for invoice footer
    companyPhone   String? // Business phone
    companyEmail   String? // Business email
    companyTaxId   String? // Tax ID for invoices
    companyLogo    String? // Logo URL for branded invoices

    // Invoice Settings (workspace-level defaults)
    invoiceNumberPrefix String?  @default("INV-") // Prefix for invoice numbers
    defaultCurrency     String?  @default("USD") // Default currency
    defaultPaymentTerms String? // e.g., "Net 30"
    defaultTaxRate      Decimal? @db.Decimal(10, 2) // Default tax percentage
    invoiceFooterText   String? // Custom footer text
    invoiceColor        String? // Brand color for invoices

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    clients        Client[]
    invoices       Invoice[]
    estimates      Estimate[]
    payments       Payment[]
    catalogs       Catalog[]
    businesses     Business[]
    paymentMethods WorkspacePaymentMethod[]

    // Subscription fields (cached from Stripe - Stripe is source of truth)
    stripeCustomerId     String?             @unique
    stripeSubscriptionId String?             @unique
    subscriptionPlan     SubscriptionPlan?
    subscriptionStatus   SubscriptionStatus?
    // TODO: AI CREDITS - Add fields for AI credit tracking
    // aiCreditBalance      Decimal?@db.Decimal(10,2)           @default(0)
    // aiCreditResetDate    DateTime?

    @@index([clerkId])
    @@index([stripeCustomerId])
    @@index([stripeSubscriptionId])
    @@index([subscriptionStatus])
    @@map("workspaces")
}

model Client {
    id                            Int      @id @default(autoincrement())
    workspaceId                   Int
    name                          String
    email                         String
    phone                         String?
    address                       String?
    nit                           String?
    businessName                  String?
    sequence                      Int
    // Reminder settings (null = disabled)
    reminderBeforeDueIntervalDays Int? // e.g. 3 = every 3 days while invoice active
    reminderAfterDueIntervalDays  Int? // e.g. 1 = every 1 day when past due
    createdAt                     DateTime @default(now())
    updatedAt                     DateTime @updatedAt

    workspace Workspace  @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
    invoices  Invoice[]
    estimates Estimate[]

    @@unique([workspaceId, sequence])
    @@index([workspaceId])
    @@map("clients")
}

model Catalog {
    id          Int @id @default(autoincrement())
    workspaceId Int
    businessId  Int

    name         String
    description  String
    price        Decimal      @db.Decimal(10, 2)
    quantityUnit QuantityUnit @default(UNITS) // Default quantity unit for items created from catalog
    sequence     Int
    createdAt    DateTime     @default(now())
    updatedAt    DateTime     @updatedAt

    workspace    Workspace     @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
    business     Business      @relation(fields: [businessId], references: [id], onDelete: Restrict)
    invoiceItems InvoiceItem[]

    @@unique([workspaceId, sequence])
    @@index([workspaceId])
    @@index([workspaceId, businessId])
    @@map("catalog")
}

enum InvoiceStatus {
    DRAFT
    SENT
    VIEWED
    PAID
    OVERDUE
}

enum TaxMode {
    BY_PRODUCT
    BY_TOTAL
    NONE
}

enum QuantityUnit {
    DAYS
    HOURS
    UNITS
}

enum DiscountType {
    PERCENTAGE
    FIXED
    NONE
}

enum PaymentMethodType {
    PAYPAL
    VENMO
    ZELLE
}

model WorkspacePaymentMethod {
    id          Int               @id @default(autoincrement())
    workspaceId Int
    type        PaymentMethodType
    handle      String? // e.g. paypal.me/you, @username, +15550000
    isEnabled   Boolean           @default(true)
    createdAt   DateTime          @default(now())
    updatedAt   DateTime          @updatedAt

    workspace Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
    invoices  Invoice[]

    @@unique([workspaceId, type])
    @@index([workspaceId])
    @@map("workspace_payment_methods")
}

model Invoice {
    id          Int @id @default(autoincrement())
    workspaceId Int
    clientId    Int
    businessId  Int

    // Client Information
    clientEmail   String
    clientPhone   String?
    clientAddress String?

    sequence                Int
    invoiceNumber           String
    status                  InvoiceStatus @default(DRAFT)
    issueDate               DateTime
    dueDate                 DateTime
    purchaseOrder           String? // Optional purchase order number
    customHeader            String? // Optional custom header with work details
    currency                String        @default("USD")
    subtotal                Decimal       @default(0) @db.Decimal(10, 2)
    totalTax                Decimal       @default(0) @db.Decimal(10, 2)
    discount                Decimal       @default(0) @db.Decimal(10, 2)
    discountType            DiscountType  @default(NONE) // "PERCENTAGE", "FIXED", or "NONE"
    taxMode                 TaxMode       @default(NONE) // "BY_PRODUCT", "BY_TOTAL", or "NONE"
    taxName                 String? // Tax name when taxMode is "BY_TOTAL"
    taxPercentage           Decimal?      @db.Decimal(10, 2) // Tax percentage when taxMode is "BY_TOTAL"
    total                   Decimal       @default(0) @db.Decimal(10, 2)
    balance                 Decimal       @default(0) @db.Decimal(10, 2)
    notes                   String?
    terms                   String?
    paymentLink             String?
    paymentProvider         String? // "stripe" or "paypal"
    sentAt                  DateTime?
    viewedAt                DateTime?
    paidAt                  DateTime?
    lastReminderSentAt      DateTime? // When we last sent a reminder (for interval enforcement)
    selectedPaymentMethodId Int?
    createdAt               DateTime      @default(now())
    updatedAt               DateTime      @updatedAt

    workspace             Workspace               @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
    client                Client                  @relation(fields: [clientId], references: [id], onDelete: Restrict)
    business              Business                @relation(fields: [businessId], references: [id], onDelete: Restrict)
    selectedPaymentMethod WorkspacePaymentMethod? @relation(fields: [selectedPaymentMethodId], references: [id], onDelete: SetNull)
    items                 InvoiceItem[]
    payments              Payment[]

    @@unique([workspaceId, businessId, invoiceNumber])
    @@unique([workspaceId, sequence])
    @@index([workspaceId])
    @@index([clientId])
    @@index([status])
    @@index([createdAt])
    @@map("invoices")
}

model InvoiceItem {
    id           Int          @id @default(autoincrement())
    invoiceId    Int
    name         String // Product/service name
    description  String
    quantity     Decimal      @default(1)
    quantityUnit QuantityUnit @default(UNITS) // "DAYS" or "HOURS" for display
    unitPrice    Decimal      @db.Decimal(10, 2)
    discount     Decimal      @default(0) @db.Decimal(10, 2) // Item-level discount amount
    discountType DiscountType @default(NONE) // "none", "percentage", or "fixed"
    tax          Decimal      @default(0) @db.Decimal(10, 2) // Tax percentage (used when taxMode is "BY_PRODUCT")
    vatEnabled   Boolean      @default(false) // Checkbox for "BY_TOTAL" tax mode
    total        Decimal      @default(0) @db.Decimal(10, 2)
    catalogId    Int? // Reference to Catalog if saved from/created in catalog
    createdAt    DateTime     @default(now())
    updatedAt    DateTime     @updatedAt

    invoice Invoice  @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
    catalog Catalog? @relation(fields: [catalogId], references: [id], onDelete: SetNull)

    @@index([invoiceId])
    @@index([catalogId])
    @@map("invoice_items")
}

model Payment {
    id            Int      @id @default(autoincrement())
    workspaceId   Int
    invoiceId     Int
    amount        Decimal  @db.Decimal(10, 2)
    paymentMethod String // e.g., "cash", "bank_transfer", "check", "stripe", "paypal", etc.
    transactionId String? // Required unique transaction ID
    details       String? // Optional payment notes/details
    paidAt        DateTime @default(now())
    createdAt     DateTime @default(now())
    updatedAt     DateTime @updatedAt

    workspace Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
    invoice   Invoice   @relation(fields: [invoiceId], references: [id], onDelete: Restrict)

    @@index([workspaceId])
    @@index([invoiceId])
    @@map("payments")
}

enum EstimateStatus {
    DRAFT
    SENT
    ACCEPTED
    REJECTED
    EXPIRED
}

model Estimate {
    id          Int @id @default(autoincrement())
    workspaceId Int
    businessId  Int

    clientId       Int
    estimateNumber String
    status         EstimateStatus @default(DRAFT)
    issueDate      DateTime
    expirationDate DateTime?
    currency       String         @default("USD")
    subtotal       Decimal        @default(0) @db.Decimal(10, 2)
    totalTax       Decimal        @default(0) @db.Decimal(10, 2)
    discount       Decimal        @default(0) @db.Decimal(10, 2)
    discountType   String? // "percentage" or "fixed"
    total          Decimal        @default(0) @db.Decimal(10, 2)
    notes          String?
    terms          String?
    sentAt         DateTime?
    acceptedAt     DateTime?
    createdAt      DateTime       @default(now())
    updatedAt      DateTime       @updatedAt

    workspace Workspace      @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
    client    Client         @relation(fields: [clientId], references: [id], onDelete: Restrict)
    items     EstimateItem[]

    @@unique([workspaceId, businessId, estimateNumber])
    @@index([workspaceId])
    @@index([clientId])
    @@index([status])
    @@index([createdAt])
    @@map("estimates")
}

model EstimateItem {
    id          Int      @id @default(autoincrement())
    estimateId  Int
    description String
    quantity    Decimal  @default(1)
    unitPrice   Decimal  @db.Decimal(10, 2)
    tax         Decimal  @default(0) @db.Decimal(10, 2) // Tax percentage
    total       Decimal  @default(0) @db.Decimal(10, 2)
    createdAt   DateTime @default(now())
    updatedAt   DateTime @updatedAt

    estimate Estimate @relation(fields: [estimateId], references: [id], onDelete: Cascade)

    @@index([estimateId])
    @@map("estimate_items")
}

model Business {
    id          Int     @id @default(autoincrement())
    workspaceId Int
    name        String // Company name
    nit         String? // Tax ID (NIT/Cedula), optional
    address     String // Company address
    email       String // Business email
    phone       String // Business phone
    logo        String? // Cloudinary URL
    isDefault   Boolean @default(false) // Default business for workspace
    sequence    Int // For ordering within workspace

    // Invoice defaults (used to prefill new invoices for this business)
    defaultTaxMode       TaxMode? // "NONE" | "BY_PRODUCT" | "BY_TOTAL"
    defaultTaxName       String?
    defaultTaxPercentage Decimal? @db.Decimal(10, 2)
    defaultNotes         String?
    defaultTerms         String?

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    workspace Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
    invoices  Invoice[]
    catalog   Catalog[]

    @@unique([workspaceId, sequence])
    @@index([workspaceId])
    @@index([isDefault])
    @@map("businesses")
}

enum SubscriptionPlan {
    CORE
    AI_PRO
    LIFETIME
}

enum SubscriptionStatus {
    ACTIVE
    CANCELED
    PAST_DUE
    UNPAID
    INCOMPLETE
    INCOMPLETE_EXPIRED
    TRIALING
}
