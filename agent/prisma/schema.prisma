// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
    provider   = "prisma-client"
    output     = "../src/generated/prisma/client"
    engineType = "client"
}

datasource db {
    provider = "postgresql"
}

model Workspace {
    id      Int    @id @default(autoincrement())
    clerkId String @unique // Clerk's user ID - no need for separate User table

    // Business/Company Information (for invoices)
    name           String // Company/Workspace name
    companyName    String? // Full company name for invoices
    companyAddress String? // Company address for invoice footer
    companyPhone   String? // Business phone
    companyEmail   String? // Business email
    companyTaxId   String? // Tax ID for invoices
    companyLogo    String? // Logo URL for branded invoices

    // Invoice Settings (workspace-level defaults)
    invoiceNumberPrefix String?  @default("INV-") // Prefix for invoice numbers
    defaultCurrency     String?  @default("USD") // Default currency
    defaultPaymentTerms String? // e.g., "Net 30"
    defaultTaxRate      Decimal? // Default tax percentage
    invoiceFooterText   String? // Custom footer text
    invoiceColor        String? // Brand color for invoices

    createdAt DateTime  @default(now())
    updatedAt DateTime  @updatedAt
    deletedAt DateTime?

    clients    Client[]
    invoices   Invoice[]
    estimates  Estimate[]
    payments   Payment[]
    catalogs   Catalog[]
    businesses Business[]

    // Subscription fields (cached from Stripe - Stripe is source of truth)
    stripeCustomerId     String?             @unique
    stripeSubscriptionId String?             @unique
    subscriptionPlan     SubscriptionPlan?
    subscriptionStatus   SubscriptionStatus?
    subscriptionEndsAt   DateTime? // For quick expiry checks
    lastStripeSync       DateTime? // Track when we last verified with Stripe
    // TODO: AI CREDITS - Add fields for AI credit tracking
    // aiCreditBalance      Decimal?           @default(0)
    // aiCreditResetDate    DateTime?

    @@index([clerkId])
    @@index([stripeCustomerId])
    @@index([stripeSubscriptionId])
    @@index([subscriptionStatus])
    @@map("workspaces")
}

model Client {
    id           Int       @id @default(autoincrement())
    workspaceId  Int
    name         String
    email        String
    phone        String?
    address      String?
    nit          String?
    businessName String?
    sequence     Int
    createdAt    DateTime  @default(now())
    updatedAt    DateTime  @updatedAt
    deletedAt    DateTime?

    workspace Workspace  @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
    invoices  Invoice[]
    estimates Estimate[]

    @@unique([workspaceId, sequence])
    @@index([workspaceId])
    @@map("clients")
}

model Catalog {
    id          Int @id @default(autoincrement())
    workspaceId Int
    businessId  Int

    name         String
    description  String
    price        Decimal
    quantityUnit QuantityUnit @default(UNITS) // Default quantity unit for items created from catalog
    sequence     Int
    createdAt    DateTime     @default(now())
    updatedAt    DateTime     @updatedAt
    deletedAt    DateTime?

    workspace    Workspace     @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
    business     Business      @relation(fields: [businessId], references: [id], onDelete: Restrict)
    invoiceItems InvoiceItem[]

    @@unique([workspaceId, sequence])
    @@index([workspaceId])
    @@map("catalog")
}

enum InvoiceStatus {
    DRAFT
    SENT
    VIEWED
    PAID
    OVERDUE
}

enum TaxMode {
    BY_PRODUCT
    BY_TOTAL
    NONE
}

enum QuantityUnit {
    DAYS
    HOURS
    UNITS
}

enum DiscountType {
    PERCENTAGE
    FIXED
    NONE
}

model Invoice {
    id          Int @id @default(autoincrement())
    workspaceId Int
    clientId    Int
    businessId  Int // Optional: link invoice to specific business

    // Client Information
    clientEmail   String
    clientPhone   String?
    clientAddress String?

    sequence        Int
    invoiceNumber   String
    status          InvoiceStatus @default(DRAFT)
    issueDate       DateTime
    dueDate         DateTime
    purchaseOrder   String? // Optional purchase order number
    customHeader    String? // Optional custom header with work details
    currency        String        @default("USD")
    subtotal        Decimal       @default(0)
    totalTax        Decimal       @default(0)
    discount        Decimal       @default(0)
    discountType    DiscountType  @default(NONE) // "PERCENTAGE", "FIXED", or "NONE"
    taxMode         TaxMode       @default(NONE) // "BY_PRODUCT", "BY_TOTAL", or "NONE"
    taxName         String? // Tax name when taxMode is "BY_TOTAL"
    taxPercentage   Decimal? // Tax percentage when taxMode is "BY_TOTAL"
    total           Decimal       @default(0)
    balance         Decimal       @default(0)
    notes           String?
    terms           String?
    paymentLink     String?
    paymentProvider String? // "stripe" or "paypal"
    sentAt          DateTime?
    viewedAt        DateTime?
    paidAt          DateTime?
    createdAt       DateTime      @default(now())
    updatedAt       DateTime      @updatedAt
    deletedAt       DateTime?

    workspace Workspace     @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
    client    Client        @relation(fields: [clientId], references: [id], onDelete: Restrict)
    business  Business      @relation(fields: [businessId], references: [id], onDelete: Restrict)
    items     InvoiceItem[]
    payments  Payment[]

    @@unique([workspaceId, sequence])
    @@unique([workspaceId, invoiceNumber])
    @@index([workspaceId])
    @@index([clientId])
    @@index([status])
    @@index([createdAt])
    @@map("invoices")
}

model InvoiceItem {
    id           Int          @id @default(autoincrement())
    invoiceId    Int
    name         String // Product/service name
    description  String
    quantity     Decimal      @default(1)
    quantityUnit QuantityUnit @default(UNITS) // "DAYS" or "HOURS" for display
    unitPrice    Decimal
    discount     Decimal      @default(0) // Item-level discount amount
    discountType DiscountType @default(NONE) // "none", "percentage", or "fixed"
    tax          Decimal      @default(0) // Tax percentage (used when taxMode is "BY_PRODUCT")
    vatEnabled   Boolean      @default(false) // Checkbox for "BY_TOTAL" tax mode
    total        Decimal      @default(0)
    catalogId    Int? // Reference to Catalog if saved from/created in catalog
    createdAt    DateTime     @default(now())
    updatedAt    DateTime     @updatedAt

    invoice Invoice  @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
    catalog Catalog? @relation(fields: [catalogId], references: [id], onDelete: SetNull)

    @@index([invoiceId])
    @@index([catalogId])
    @@map("invoice_items")
}

model Payment {
    id            Int       @id @default(autoincrement())
    workspaceId   Int
    invoiceId     Int
    amount        Decimal
    paymentMethod String // e.g., "cash", "bank_transfer", "check", "stripe", "paypal", etc.
    transactionId String    @unique // Required unique transaction ID
    details       String? // Optional payment notes/details
    paidAt        DateTime  @default(now())
    createdAt     DateTime  @default(now())
    updatedAt     DateTime  @updatedAt
    deletedAt     DateTime?

    workspace Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
    invoice   Invoice   @relation(fields: [invoiceId], references: [id], onDelete: Restrict)

    @@index([workspaceId])
    @@index([invoiceId])
    @@index([transactionId])
    @@map("payments")
}

enum EstimateStatus {
    DRAFT
    SENT
    ACCEPTED
    REJECTED
    EXPIRED
}

model Estimate {
    id             Int            @id @default(autoincrement())
    workspaceId    Int
    clientId       Int
    estimateNumber String
    status         EstimateStatus @default(DRAFT)
    issueDate      DateTime
    expirationDate DateTime?
    currency       String         @default("USD")
    subtotal       Decimal        @default(0)
    totalTax       Decimal        @default(0)
    discount       Decimal        @default(0)
    discountType   String? // "percentage" or "fixed"
    total          Decimal        @default(0)
    notes          String?
    terms          String?
    sentAt         DateTime?
    acceptedAt     DateTime?
    createdAt      DateTime       @default(now())
    updatedAt      DateTime       @updatedAt
    deletedAt      DateTime?

    workspace Workspace      @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
    client    Client         @relation(fields: [clientId], references: [id], onDelete: Restrict)
    items     EstimateItem[]

    @@unique([workspaceId, estimateNumber])
    @@index([workspaceId])
    @@index([clientId])
    @@index([status])
    @@index([createdAt])
    @@map("estimates")
}

model EstimateItem {
    id          Int      @id @default(autoincrement())
    estimateId  Int
    description String
    quantity    Decimal  @default(1)
    unitPrice   Decimal
    tax         Decimal  @default(0) // Tax percentage
    total       Decimal  @default(0)
    createdAt   DateTime @default(now())
    updatedAt   DateTime @updatedAt

    estimate Estimate @relation(fields: [estimateId], references: [id], onDelete: Cascade)

    @@index([estimateId])
    @@map("estimate_items")
}

model Business {
    id          Int       @id @default(autoincrement())
    workspaceId Int
    name        String // Company name
    nit         String // Tax ID (NIT/Cedula)
    address     String // Company address
    email       String // Business email
    phone       String // Business phone
    logo        String? // Cloudinary URL
    isDefault   Boolean   @default(false) // Default business for workspace
    sequence    Int // For ordering within workspace
    createdAt   DateTime  @default(now())
    updatedAt   DateTime  @updatedAt
    deletedAt   DateTime?

    workspace Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
    invoices  Invoice[]
    catalog   Catalog[]

    @@unique([workspaceId, sequence])
    @@index([workspaceId])
    @@index([isDefault])
    @@map("businesses")
}

enum SubscriptionPlan {
    CORE
    AI_PRO
    LIFETIME
}

enum SubscriptionStatus {
    ACTIVE
    CANCELED
    PAST_DUE
    UNPAID
    INCOMPLETE
    INCOMPLETE_EXPIRED
    TRIALING
}
